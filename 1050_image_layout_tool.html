<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <title>圖片合成工具 - 清晰壓縮版</title>
  <style>
    body { font-family: sans-serif; padding: 20px; background: #f8f8f8; }
    #image-list {
      display: grid;
      grid-template-columns: repeat(4, 512px);
      grid-template-rows: repeat(3, 293px);
      gap: 35px 0;
      width: 2048px;
      height: calc(3 * 293px + 2 * 35px);
      margin-bottom: 20px;
      background: white;
    }
    .thumb {
      width: 512px;
      height: 293px;
      overflow: hidden;
      position: relative;
      border: 1px solid #ccc;
      background: #fff;
    }
    .thumb img {
      position: absolute;
      top: 50%; left: 50%;
      max-width: 100%;
      max-height: 100%;
      transform: translate(-50%, -50%);
    }
    .thumb[draggable] {
      cursor: grab;
    }
    #canvas-preview {
      border: 1px solid #999;
      margin-top: 20px;
      background: white;
      max-width: 100%;
    }
    button, select {
      margin: 5px;
      padding: 8px 16px;
      font-size: 16px;
    }
  </style>
</head>
<body>
  <h2>圖片排版工具（3 行 4 欄） - 高畫質 JPEG 壓縮版</h2>
  <input type="file" id="file-input" multiple accept="image/*">
  <button onclick="generateImage()">產生合成圖</button>
  <button onclick="downloadImage()">下載圖片</button>
  <div id="image-list"></div>
  <canvas id="canvas-preview" width="2048" height="1015"></canvas>

  <script>
    const input = document.getElementById('file-input');
    const list = document.getElementById('image-list');
    const canvas = document.getElementById('canvas-preview');
    const ctx = canvas.getContext('2d');

    input.addEventListener('change', (e) => {
      list.innerHTML = '';
      const files = Array.from(e.target.files).slice(0, 12); // 最多12張
      files.forEach(file => {
        const reader = new FileReader();
        reader.onload = (ev) => {
          const img = document.createElement('img');
          img.onload = () => {
            const wrapper = document.createElement('div');
            wrapper.className = 'thumb';
            wrapper.setAttribute('draggable', 'true');
            wrapper.appendChild(img);
            list.appendChild(wrapper);
            enableDragDrop();
          };
          img.src = ev.target.result;
        };
        reader.readAsDataURL(file);
      });
    });

    function enableDragDrop() {
      let dragged;
      list.querySelectorAll('.thumb').forEach(item => {
        item.addEventListener('dragstart', e => { dragged = item; });
        item.addEventListener('dragover', e => { e.preventDefault(); });
        item.addEventListener('drop', e => {
          e.preventDefault();
          if (dragged !== item) {
            const draggedIndex = [...list.children].indexOf(dragged);
            const targetIndex = [...list.children].indexOf(item);
            if (draggedIndex < targetIndex) {
              list.insertBefore(dragged, item.nextSibling);
            } else {
              list.insertBefore(dragged, item);
            }
          }
        });
      });
    }

    function generateImage() {
      const baseWidth = 2048;
      const baseHeight = 1015;

      canvas.width = baseWidth;
      canvas.height = baseHeight;

      ctx.fillStyle = "#fff";
      ctx.fillRect(0, 0, baseWidth, baseHeight);

      const thumbs = list.querySelectorAll('.thumb img');

      Promise.all(Array.from(thumbs).map(img => {
        return new Promise(resolve => {
          if (img.complete) resolve();
          else img.onload = resolve;
        });
      })).then(() => {
        thumbs.forEach((img, index) => {
          const row = Math.floor(index / 4);
          const col = index % 4;
          const cellWidth = 512;
          const cellHeight = 293;
          const x = col * cellWidth;
          const y = 33 + row * (cellHeight + 35); // 含上下邊距

          const s = Math.min(cellWidth / img.naturalWidth, cellHeight / img.naturalHeight);
          const w = img.naturalWidth * s;
          const h = img.naturalHeight * s;
          const dx = x + (cellWidth - w) / 2;
          const dy = y + (cellHeight - h) / 2;

          ctx.drawImage(img, dx, dy, w, h);
        });
      });
    }

    function downloadImage() {
      const link = document.createElement('a');
      link.download = 'merged-image.jpg';
      link.href = canvas.toDataURL('image/jpeg', 0.95); // 調整壓縮品質
      link.click();
    }
  </script>
</body>
</html>
